import { getTransactionReceipt, mine, reset } from "viem/actions";
import { beforeEach, expect, test } from "vitest";
import { anvilSepolia } from "~test/src/anvil.js";
import { accounts } from "~test/src/constants.js";
import { mantleSepoliaTestnet } from "../chains/mantleSepoliaTestnet.js";
import { finalizeWithdrawal } from "./finalizeWithdrawal.js";

const sepoliaClient = anvilSepolia.getClient();

const withdrawal = {
	nonce:
		1766847064778384329583297500742918515827483896875618958121606201292655218n,
	sender: "0x4200000000000000000000000000000000000007",
	target: "0x37dAC5312e31Adb8BB0802Fc72Ca84DA5cDfcb4c",
	ethValue: 0n,
	gasLimit: 287624n,
	mntValue: 1000000000000000000n,
	data: "0xff8daf150001000000000000000000000000000000000000000000000000000000008a72000000000000000000000000420000000000000000000000000000000000001000000000000000000000000021f308067241b2028503c07bd7cb3751ffab0fb20000000000000000000000000000000000000000000000000de0b6b3a76400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000a4f407a99e000000000000000000000000c3ac498cdfb6e1dcfa17cbc55e514560f26a1922000000000000000000000000c3ac498cdfb6e1dcfa17cbc55e514560f26a19220000000000000000000000000000000000000000000000000de0b6b3a76400000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
	withdrawalHash:
		"0xa490493880743334cb2a899bc3659363c6263c78fc7f6bf59c2e0e932758b728",
} as const;

beforeEach(async () => {
	await reset(sepoliaClient, {
		blockNumber: 5894862n,
		jsonRpcUrl: anvilSepolia.forkUrl,
	});
});

test("default", async () => {
	const hash = await finalizeWithdrawal(sepoliaClient, {
		account: accounts[0].address,
		targetChain: mantleSepoliaTestnet,
		withdrawal,
	});
	expect(hash).toBeDefined();

	await mine(sepoliaClient, { blocks: 1 });

	const receipt = await getTransactionReceipt(sepoliaClient, {
		hash,
	});
	expect(receipt.status).toEqual("success");
});
